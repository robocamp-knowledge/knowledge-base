name: Sync & clean ONE blog article (manual, no map)

on:
  workflow_dispatch:
    inputs:
      article_id:
        description: "Article slug (e.g. lego-science-review)"
        required: true
      lang:
        description: "Language (pl or en)"
        required: true
      src_repo_path:
        description: "Path in robocamp-new-web repo (e.g. data/blogposts/pl/.../content.md)"
        required: true

jobs:
  sync_clean_one:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout knowledge-base
        uses: actions/checkout@v4

      - name: Checkout robocamp-new-web (read-only source)
        uses: actions/checkout@v4
        with:
          repository: robodevelopers/robocamp-new-web
          token: ${{ secrets.ROBOCAMP_NEW_WEB_PAT }}
          path: _sources/robocamp-new-web

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Debug inputs & filesystem
        run: |
          set -e
          echo "article_id=${{ inputs.article_id }}"
          echo "lang=${{ inputs.lang }}"
          echo "src_repo_path=${{ inputs.src_repo_path }}"
          echo ""
          echo "PWD:"
          pwd
          echo ""
          echo "Checking source file:"
          SRC="_sources/robocamp-new-web/${{ inputs.src_repo_path }}"
          echo "$SRC"
          test -f "$SRC" && echo "Source exists ✅" || (echo "Source missing ❌" && exit 1)

      - name: Run cleaner
        run: |
          python tools/cleaner/clean_one.py \
            --article-id "${{ inputs.article_id }}" \
            --lang "${{ inputs.lang }}" \
            --src "_sources/robocamp-new-web/${{ inputs.src_repo_path }}" \
            --target "blog/articles/${{ inputs.article_id }}/${{ inputs.lang }}/full.md"

      - name: Commit changes
        run: |
          git status
          git add blog/articles/${{ inputs.article_id }}/${{ inputs.lang }}/full.md
          git commit -m "Update full.md for ${{ inputs.article_id }} (${{ inputs.lang }})" || echo "Nothing to commit"
          git push
