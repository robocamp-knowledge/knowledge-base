name: Sync & clean ONE blog article (manual)

on:
  workflow_dispatch:
    inputs:
      article_id:
        description: "Article ID / slug (e.g. lego-science-review)"
        required: true
      lang:
        description: "Language (pl or en)"
        required: true
      src_repo_path:
        description: "Path in robocamp-new-web repo (e.g. data/blogposts/pl/.../content.md)"
        required: true

permissions:
  contents: write   # üî¥ KONIECZNE do commit + push

jobs:
  sync_clean_one:
    runs-on: ubuntu-latest

    steps:
      # --- MAIN REPO ---
      - name: Checkout knowledge-base
        uses: actions/checkout@v4

      # --- SOURCE REPO (READ-ONLY) ---
      - name: Checkout robocamp-new-web (read-only)
        uses: actions/checkout@v4
        with:
          repository: robodevelopers/robocamp-new-web
          token: ${{ secrets.ROBOCAMP_NEW_WEB_PAT }}
          path: _sources/robocamp-new-web

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --- DEBUG INPUTS ---
      - name: Debug inputs & source
        run: |
          set -e
          echo "article_id=${{ inputs.article_id }}"
          echo "lang=${{ inputs.lang }}"
          echo "src_repo_path=${{ inputs.src_repo_path }}"
          echo ""
          echo "PWD:"
          pwd
          echo ""
          SRC="_sources/robocamp-new-web/${{ inputs.src_repo_path }}"
          echo "Checking source file:"
          echo "$SRC"
          test -f "$SRC" && echo "Source exists ‚úÖ" || (echo "Source missing ‚ùå" && exit 1)

      # --- CLEANER ---
      - name: Run cleaner
        run: |
          python tools/cleaner/clean_one.py \
            --article-id "${{ inputs.article_id }}" \
            --lang "${{ inputs.lang }}" \
            --src "_sources/robocamp-new-web/${{ inputs.src_repo_path }}" \
            --target "blog/articles/${{ inputs.article_id }}/${{ inputs.lang }}/full.md"

      # --- GIT CONFIG (CRITICAL) ---
      - name: Configure git identity
        run: |
          git config user.name "robocamp-bot"
          git config user.email "bot@robocamp.eu"

      # --- COMMIT & PUSH ---
      - name: Commit and push changes
        run: |
          git add blog/articles/${{ inputs.article_id }}/${{ inputs.lang }}/full.md
          git commit -m "Update full.md for ${{ inputs.article_id }} (${{ inputs.lang }})" || echo "Nothing to commit"
          git push
